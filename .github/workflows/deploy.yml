name: Deploy to Azure App Service

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Debug - List all files
      run: |
        echo "ğŸ“ Project structure:"
        ls -la
        echo "ğŸ“ API content:"
        ls -la api/ || echo "No API folder"
        echo "ğŸ“ GitHub folder:"
        ls -la .github/ || echo "No .github folder"

    - name: Create zip package
      run: |
        zip -r deployment.zip . -x ".git/*" ".github/*" ".venv/*" "__pycache__/*" "*.gitignore"

    - name: Debug - Show zip contents
      run: |
        echo "ğŸ“¦ Zip file contents:"
        unzip -l deployment.zip | head -20

    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Debug - List Azure Web Apps
      run: |
        echo "ğŸŒ Your Azure Web Apps:"
        az webapp list --query "[].{Name:name, State:state}" --output table

    - name: Deploy using Azure CLI
      run: |
        az webapp deploy \
          --name hamzamir-resume-app-gzgwc0d9f2csexgt \
          --resource-group $(az webapp show --name hamzamir-resume-app-gzgwc0d9f2csexgt --query resourceGroup -o tsv) \
          --src-path deployment.zip \
          --type zip

    - name: Verify deployment
      run: |
        echo "âœ… Deployment attempted"
        echo "Check https://hamzamir-resume-app-gzgwc0d9f2csexgt.azurewebsites.net"